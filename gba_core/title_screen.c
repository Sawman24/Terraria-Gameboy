// ============================================================
// Terraria GBA - Title Screen
// Static logo + splash text + blinking Press START + music
// ============================================================
#include "audio.h"
#include "theme_data.h"
#include "game_data.h"

#define TITLE_MODE_3     0x0003
#define TITLE_BG2_ENABLE 0x0400
#define TITLE_SCREEN_W   240
#define TITLE_SCREEN_H   160
#define TITLE_VRAM ((volatile uint16_t*)0x06000000)

// Splash texts removed (unused)

// --- 8x8 bitmap font ---
static const unsigned char font8[96][8] = {
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, // ' '
    {0x18,0x18,0x18,0x18,0x18,0x00,0x18,0x00}, // '!'
    {0x6C,0x6C,0x24,0x00,0x00,0x00,0x00,0x00}, // '"'
    {0x6C,0xFE,0x6C,0x6C,0xFE,0x6C,0x00,0x00}, // '#'
    {0x18,0x7E,0x58,0x7E,0x1A,0x7E,0x18,0x00}, // '$'
    {0x62,0x64,0x08,0x10,0x26,0x46,0x00,0x00}, // '%'
    {0x38,0x6C,0x38,0x76,0xDC,0x76,0x00,0x00}, // '&'
    {0x18,0x18,0x10,0x00,0x00,0x00,0x00,0x00}, // '\''
    {0x0C,0x18,0x30,0x30,0x30,0x18,0x0C,0x00}, // '('
    {0x30,0x18,0x0C,0x0C,0x0C,0x18,0x30,0x00}, // ')'
    {0x00,0x66,0x3C,0xFF,0x3C,0x66,0x00,0x00}, // '*'
    {0x00,0x18,0x18,0x7E,0x18,0x18,0x00,0x00}, // '+'
    {0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x30}, // ','
    {0x00,0x00,0x00,0x7E,0x00,0x00,0x00,0x00}, // '-'
    {0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x00}, // '.'
    {0x02,0x06,0x0C,0x18,0x30,0x60,0x40,0x00}, // '/'
    {0x3C,0x66,0x6E,0x76,0x66,0x66,0x3C,0x00}, // '0'
    {0x18,0x38,0x18,0x18,0x18,0x18,0x7E,0x00}, // '1'
    {0x3C,0x66,0x06,0x0C,0x18,0x30,0x7E,0x00}, // '2'
    {0x3C,0x66,0x06,0x1C,0x06,0x66,0x3C,0x00}, // '3'
    {0x0C,0x1C,0x3C,0x6C,0x7E,0x0C,0x0C,0x00}, // '4'
    {0x7E,0x60,0x7C,0x06,0x06,0x66,0x3C,0x00}, // '5'
    {0x1C,0x30,0x60,0x7C,0x66,0x66,0x3C,0x00}, // '6'
    {0x7E,0x06,0x0C,0x18,0x30,0x30,0x30,0x00}, // '7'
    {0x3C,0x66,0x66,0x3C,0x66,0x66,0x3C,0x00}, // '8'
    {0x3C,0x66,0x66,0x3E,0x06,0x0C,0x38,0x00}, // '9'
    {0x00,0x00,0x18,0x00,0x00,0x18,0x00,0x00}, // ':'
    {0x00,0x00,0x18,0x00,0x00,0x18,0x18,0x30}, // ';'
    {0x06,0x0C,0x18,0x30,0x18,0x0C,0x06,0x00}, // '<'
    {0x00,0x00,0x7E,0x00,0x7E,0x00,0x00,0x00}, // '='
    {0x60,0x30,0x18,0x0C,0x18,0x30,0x60,0x00}, // '>'
    {0x3C,0x66,0x06,0x0C,0x18,0x00,0x18,0x00}, // '?'
    {0x3C,0x66,0x6E,0x6A,0x6E,0x60,0x3E,0x00}, // '@'
    {0x18,0x3C,0x66,0x7E,0x66,0x66,0x66,0x00}, // 'A'
    {0x7C,0x66,0x66,0x7C,0x66,0x66,0x7C,0x00}, // 'B'
    {0x3C,0x66,0x60,0x60,0x60,0x66,0x3C,0x00}, // 'C'
    {0x78,0x6C,0x66,0x66,0x66,0x6C,0x78,0x00}, // 'D'
    {0x7E,0x60,0x60,0x78,0x60,0x60,0x7E,0x00}, // 'E'
    {0x7E,0x60,0x60,0x78,0x60,0x60,0x60,0x00}, // 'F'
    {0x3E,0x60,0x60,0x6E,0x66,0x66,0x3E,0x00}, // 'G'
    {0x66,0x66,0x66,0x7E,0x66,0x66,0x66,0x00}, // 'H'
    {0x3C,0x18,0x18,0x18,0x18,0x18,0x3C,0x00}, // 'I'
    {0x06,0x06,0x06,0x06,0x66,0x66,0x3C,0x00}, // 'J'
    {0x66,0x6C,0x78,0x70,0x78,0x6C,0x66,0x00}, // 'K'
    {0x60,0x60,0x60,0x60,0x60,0x60,0x7E,0x00}, // 'L'
    {0xC6,0xEE,0xFE,0xD6,0xC6,0xC6,0xC6,0x00}, // 'M'
    {0x66,0x76,0x7E,0x7E,0x6E,0x66,0x66,0x00}, // 'N'
    {0x3C,0x66,0x66,0x66,0x66,0x66,0x3C,0x00}, // 'O'
    {0x7C,0x66,0x66,0x7C,0x60,0x60,0x60,0x00}, // 'P'
    {0x3C,0x66,0x66,0x66,0x6A,0x6C,0x36,0x00}, // 'Q'
    {0x7C,0x66,0x66,0x7C,0x6C,0x66,0x66,0x00}, // 'R'
    {0x3C,0x66,0x60,0x3C,0x06,0x66,0x3C,0x00}, // 'S'
    {0x7E,0x18,0x18,0x18,0x18,0x18,0x18,0x00}, // 'T'
    {0x66,0x66,0x66,0x66,0x66,0x66,0x3E,0x00}, // 'U'
    {0x66,0x66,0x66,0x66,0x66,0x3C,0x18,0x00}, // 'V'
    {0xC6,0xC6,0xC6,0xD6,0xFE,0xEE,0xC6,0x00}, // 'W'
    {0x66,0x66,0x3C,0x18,0x3C,0x66,0x66,0x00}, // 'X'
    {0x66,0x66,0x66,0x3C,0x18,0x18,0x18,0x00}, // 'Y'
    {0x7E,0x06,0x0C,0x18,0x30,0x60,0x7E,0x00}, // 'Z'
    {0x3C,0x30,0x30,0x30,0x30,0x30,0x3C,0x00}, // '['
    {0x40,0x60,0x30,0x18,0x0C,0x06,0x02,0x00}, // '\\'
    {0x3C,0x0C,0x0C,0x0C,0x0C,0x0C,0x3C,0x00}, // ']'
    {0x18,0x3C,0x66,0x00,0x00,0x00,0x00,0x00}, // '^'
    {0x00,0x00,0x00,0x00,0x00,0x00,0xFE,0x00}, // '_'
    {0x30,0x18,0x0C,0x00,0x00,0x00,0x00,0x00}, // '`'
    {0x00,0x00,0x3C,0x06,0x3E,0x66,0x3E,0x00}, // 'a'
    {0x60,0x60,0x7C,0x66,0x66,0x66,0x7C,0x00}, // 'b'
    {0x00,0x00,0x3C,0x66,0x60,0x66,0x3C,0x00}, // 'c'
    {0x06,0x06,0x3E,0x66,0x66,0x66,0x3E,0x00}, // 'd'
    {0x00,0x00,0x3C,0x66,0x7E,0x60,0x3C,0x00}, // 'e'
    {0x1C,0x30,0x7C,0x30,0x30,0x30,0x30,0x00}, // 'f'
    {0x00,0x00,0x3E,0x66,0x66,0x3E,0x06,0x3C}, // 'g'
    {0x60,0x60,0x7C,0x66,0x66,0x66,0x66,0x00}, // 'h'
    {0x18,0x00,0x38,0x18,0x18,0x18,0x3C,0x00}, // 'i'
    {0x0C,0x00,0x1C,0x0C,0x0C,0x0C,0x6C,0x38}, // 'j'
    {0x60,0x60,0x66,0x6C,0x78,0x6C,0x66,0x00}, // 'k'
    {0x38,0x18,0x18,0x18,0x18,0x18,0x3C,0x00}, // 'l'
    {0x00,0x00,0xEC,0xFE,0xD6,0xC6,0xC6,0x00}, // 'm'
    {0x00,0x00,0x7C,0x66,0x66,0x66,0x66,0x00}, // 'n'
    {0x00,0x00,0x3C,0x66,0x66,0x66,0x3C,0x00}, // 'o'
    {0x00,0x00,0x7C,0x66,0x66,0x7C,0x60,0x60}, // 'p'
    {0x00,0x00,0x3E,0x66,0x66,0x3E,0x06,0x06}, // 'q'
    {0x00,0x00,0x7C,0x66,0x60,0x60,0x60,0x00}, // 'r'
    {0x00,0x00,0x3E,0x60,0x3C,0x06,0x7C,0x00}, // 's'
    {0x30,0x30,0x7C,0x30,0x30,0x30,0x1C,0x00}, // 't'
    {0x00,0x00,0x66,0x66,0x66,0x66,0x3E,0x00}, // 'u'
    {0x00,0x00,0x66,0x66,0x66,0x3C,0x18,0x00}, // 'v'
    {0x00,0x00,0xC6,0xC6,0xD6,0xFE,0x6C,0x00}, // 'w'
    {0x00,0x00,0x66,0x3C,0x18,0x3C,0x66,0x00}, // 'x'
    {0x00,0x00,0x66,0x66,0x66,0x3E,0x06,0x3C}, // 'y'
    {0x00,0x00,0x7E,0x0C,0x18,0x30,0x7E,0x00}, // 'z'
    {0x0C,0x18,0x18,0x70,0x18,0x18,0x0C,0x00}, // '{'
    {0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x00}, // '|'
    {0x30,0x18,0x18,0x0E,0x18,0x18,0x30,0x00}, // '}'
    {0x00,0x00,0x76,0xDC,0x00,0x00,0x00,0x00}, // '~'
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, // DEL
};

// COS20/SIN20 removed (unused)

static inline void title_vsync(void) {
    while (REG_VCOUNT >= 160);
    while (REG_VCOUNT < 160);
}

static inline void title_plot(int x, int y, unsigned short color) {
    if ((unsigned)x < TITLE_SCREEN_W && (unsigned)y < TITLE_SCREEN_H)
        TITLE_VRAM[y * TITLE_SCREEN_W + x] = color;
}

// Blit sprite with alpha
static void title_blit_sprite(const unsigned short* pixels, const unsigned char* alpha,
                        int w, int h, int dx, int dy) {
    int sx, sy;
    for (sy = 0; sy < h; sy++) {
        int screen_y = dy + sy;
        if ((unsigned)screen_y >= TITLE_SCREEN_H) continue;
        for (sx = 0; sx < w; sx++) {
            int screen_x = dx + sx;
            if ((unsigned)screen_x >= TITLE_SCREEN_W) continue;
            int idx = sy * w + sx;
            if (alpha[idx])
                TITLE_VRAM[screen_y * TITLE_SCREEN_W + screen_x] = pixels[idx];
        }
    }
}

// Draw single char at pixel position
static void title_draw_char(int ch, int px, int py, unsigned short color) {
    int ci = ch - 32;
    int row, col;
    if (ci < 0 || ci >= 96) return;
    for (row = 0; row < 8; row++) {
        unsigned char bits = font8[ci][row];
        for (col = 0; col < 8; col++) {
            if (bits & (0x80 >> col))
                title_plot(px + col, py + row, color);
        }
    }
}

// draw_text_angled removed (unused)

// Draw horizontal text
static void title_draw_text(const char* text, int x, int y,
                      unsigned short color, unsigned short outline) {
    int i = 0;
    while (text[i]) {
        int px = x + i * 8;
        title_draw_char(text[i], px-1, y, outline);
        title_draw_char(text[i], px+1, y, outline);
        title_draw_char(text[i], px, y-1, outline);
        title_draw_char(text[i], px, y+1, outline);
        title_draw_char(text[i], px, y, color);
        i++;
    }
}

static int title_str_len(const char* s) { int n=0; while(s[n]) n++; return n; }

// title_rand_next removed (unused)

// Store BG pixels for the "Press START" region so we can restore them
static unsigned short start_region[240 * 30]; // Bigger for multiple menu lines

int run_title_screen(void) {
    REG_DISPCNT = TITLE_MODE_3 | TITLE_BG2_ENABLE;
    
    // --- 1. Draw background (once) ---
    REG_DMA3SAD = (unsigned int)bg_bitmap;
    REG_DMA3DAD = (unsigned int)TITLE_VRAM;
    REG_DMA3CNT = (TITLE_SCREEN_W * TITLE_SCREEN_H) | DMA_ENABLE;
    
    // --- Start playing theme music (PSG) ---
    audio_init();
    audio_play_song(theme_notes, THEME_NUM_EVENTS);
    
    // --- 2. Draw logo (static, moved up) ---
    int logo_x = (TITLE_SCREEN_W - 192) / 2;  // center 192px wide
    int logo_y = 30;  // moved up
    
    title_blit_sprite(logo_0_pixels, logo_0_alpha, LOGO_0_W, LOGO_0_H, logo_x, logo_y);
    title_blit_sprite(logo_1_pixels, logo_1_alpha, LOGO_1_W, LOGO_1_H, logo_x + 64, logo_y);
    title_blit_sprite(logo_2_pixels, logo_2_alpha, LOGO_2_W, LOGO_2_H, logo_x + 128, logo_y);
    
    // --- 3. Draw splash text (centered below logo) ---
    const char* splash = "Now on Game Boy!";
    int slen = title_str_len(splash);
    int splash_x = (TITLE_SCREEN_W - slen * 8) / 2;
    int splash_y = logo_y + 62;
    title_draw_text(splash, splash_x, splash_y, 0x03FF, 0x0000);
    
    // --- 4. Save the menu background region ---
    int sx = (TITLE_SCREEN_W - 140) / 2;
    int sy = 130;
    for (int y = 0; y < 30; y++) {
        for (int x = 0; x < 140; x++) {
            start_region[y * 140 + x] = TITLE_VRAM[(sy + y) * TITLE_SCREEN_W + (sx + x)];
        }
    }
    
    unsigned int frame = 0;
    int prev_visible = -1;
    int state = 0; // 0 = Press Start, 1 = Menu
    int menu_idx = 0; // 0 = Continue, 1 = New Game
    
    volatile uint8_t* sram = (volatile uint8_t*)0x0E000000;
    int has_save = (sram[0] == 'T' && sram[1] == 'E' && sram[2] == 'R' && sram[3] == 'R');
    
    // Wait for no keys pressed first just in case
    while (~REG_KEYINPUT & (KEY_START | KEY_A)) { title_vsync(); audio_update(); }
    
    int key_cooldown = 0;

    while (1) {
        title_vsync();
        frame++;
        seed += 13;
        audio_update();
        if (key_cooldown > 0) key_cooldown--;

        if (state == 0) {
            if ((~REG_KEYINPUT & KEY_START) || (~REG_KEYINPUT & KEY_A)) {
                if (!has_save) {
                    audio_stop();
                    for (int i=0; i<TITLE_SCREEN_W * TITLE_SCREEN_H; i++) TITLE_VRAM[i] = 0;
                    return 0; // New Game
                }
                state = 1;
                prev_visible = -1; // Force redraw
                key_cooldown = 15;
            }
            
            int visible = (frame / 30) & 1;
            if (visible != prev_visible) {
                prev_visible = visible;
                // Restore bg
                for (int y = 0; y < 30; y++) {
                    for (int x = 0; x < 140; x++) TITLE_VRAM[(sy + y) * TITLE_SCREEN_W + (sx + x)] = start_region[y * 140 + x];
                }
                if (visible) {
                    title_draw_text("- Press START -", sx + 10, sy + 8, 0x7FFF, 0x0000);
                }
            }
        } else if (state == 1) {
            // Menu
            if (key_cooldown == 0) {
                if (~REG_KEYINPUT & 0x0080) { menu_idx = 1; prev_visible = -1; key_cooldown = 10; } // KEY_DOWN_BTN is 0x0080
                if (~REG_KEYINPUT & 0x0040) { menu_idx = 0; prev_visible = -1; key_cooldown = 10; } // KEY_UP is 0x0040
                if (~REG_KEYINPUT & 0x0001) { // KEY_A is 0x0001
                    audio_stop();
                    for (int i=0; i<TITLE_SCREEN_W * TITLE_SCREEN_H; i++) TITLE_VRAM[i] = 0;
                    return (menu_idx == 0) ? 1 : 0; // 1 = Continue, 0 = New
                }
            }
            
            if (prev_visible == -1) { // Redraw needed
                prev_visible = 1;
                // Restore bg
                for (int y = 0; y < 30; y++) {
                    for (int x = 0; x < 140; x++) TITLE_VRAM[(sy + y) * TITLE_SCREEN_W + (sx + x)] = start_region[y * 140 + x];
                }
                title_draw_text((menu_idx == 0) ? "> Continue" : "  Continue", sx + 10, sy, 0x7FFF, 0x0000);
                title_draw_text((menu_idx == 1) ? "> New World" : "  New World", sx + 10, sy + 12, 0x7FFF, 0x0000);
            }
        }
    }
}
